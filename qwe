Rasschityvaem ip-adresy seti soglasno usloviyam

Imya ustroistva
IP-adres
Shlyuz po umolchaniyu

ISP
dhcp



172.16.1.14/28



172.16.2.14/28


HQ-RTR
172.16.1.1/28
172.16.1.14


192.168.0.62/26



192.168.0.78/28



192.168.0.86/29


HQ-SRV
192.168.0.1/26
192.168.0.62

HQ-CLI
192.168.0.65/28
192.168.0.78

HQ-SW
192.168.0.81/29
192.168.0.86

BR-RTR
172.16.2.1/28
172.16.2.14


192.168.1.30/27


BR-SRV
192.168.1.1/27
192.168.3.30




1. Pereimenovat kompyutery

Dlya smeny imeni ustroistva ispolzuetsya utilita hostnamectl vvod komandy (ris. 1.1): 
hostnamectl set-hostname NOVOE_IMYa_USTROISTVA; exec bash – vvod (Enter)
Ris. 1.1
VSE USTROISTVA krome isp IMENA PRISVAIVAYuTSYa S DOMENNYM  ris.1.2 (dan v zadanii «au-team.irpo»)  SUFFIKSOM KROME ISP!!!!!
Ris. 1.2
Imya ustroistva izmeneno.
Dannuyu operatsiyu neobkhodimo sdelat na vsekh ustroistvakh!

2. Nastroika internet interfeisov (na ISP, HQ-R, BR-R)
1) Proverit nazvanie i MAK adresa na sootvetstvie s setevymi kartami, s pomoshchyu komandy ip a (ris. 2.1): 
ip -c a – vvod (Enter)
Ris. 2.1
ens20 - nazvanie interfeisa.
bc:24:11:13:9d:39 - MAK-adres

2) Dlya nastroiki s ip-adresov ispolzuem redaktor teksta vim (nano)
Variant nastroiki 1:	
otkryvaem fail nastroiki ip-adresa (ris.2.2):
vim /etc/net/ifaces/ens20/ipv4address

Ris. 2.2
	b) zadaem ip-adres i maskoi v otkryvshemsya faile(ris.2.3):
172.16.1.14/28
	Ris.2.3
	v) sokhranyaem fail.
	V vim ris 2.4: 
shift+:     wq
ris 2.4		
	V nano:
 ctrl+o, - enter, 
ctrl+x — vykhod

Variant nastroiki 2
pomoshchyu komandy echo ris. 2.5: 
echo `172.16.2.14/28` > /etc/net/ifaces/ens21/ipv4address
ris.2.5

	Na ustroistvakh gde trebuetsya propisyvaem shlyuz v konfiguratsionnom faile interfeisa napravlennogo vo vneshneyu set (na vsekh ustroistvakh za isklyucheniem ISP)
otkryvaem fail nastroiki ip-adresa (ris.2.6):
Variant nastroiki 
vim /etc/net/ifaces/ens19/ipv4route
Ris. 2.6
	b) zadaem ip-adres shlyuza v otkryvshemsya faile(ris.2.7):
default via 172.16.1.14
Ris.2.7
		v) sokhranyaem fail.
		vim: shift+: wq

		nano: ctrl+o, enter, 
		ctrl+x - vykhod

Variant nastroiki 2 
pomoshchyu komandy echo ris. 2.8: 
echo `default via 172.16.1.14` > /etc/net/ifaces/ens19/ipv4route
Ris. 2.8
Perezapuskaem sluzhbu network (ris.2.9)
systemctl restart network
Risunok 2.9

Proveryaem nastroiku komandoi ip -c -br a (ris. 2.10).
ip -s -br a – vvod (Enter)
ip -s -br r – vvod (Enter)
Ris.2.10

Nastroika adapterov zavershena.

!!!NA HQ-RTR nastraivaem tolko interfeis smotryashchii na ISP!!!!!!!

Prodelyvaem dannuyu operatsiyu so vsemi interfeisami (krome HQ-RTR na nem tolko 1 interfeis ens19)! Na vsekh ustroistvakh.

3. Vklyuchenie proslushivaniya portov marshrutizatsii marshrutizatorakh
Vklyuchaem forwarding dlya IPv4 posredstvom redaktirovaniya faila po puti /etc/net/sysctl.conf (ris. 3.1):

nano /etc/net/sysctl.conf – vvod (Enter)

Ris. 3.1
menyaem parametr net.ipv4.ip_forward=0 na 1. (ris. 3.2).
Ris. 3.2
sokhranyaem izmeneniya ctrl+o, enter.
Vykhodim ctrl+x.
Vvodim komandu sysctl -p.


4. Vypolnyaetsya dlya nastroiki dostupa v Internet iz setei (nastraivaetsya na ISP, HQ-R i BR-R):
Neobkhodimo nastroit fail konfiguratsii nakhodyashchiisya po adresu /etc/nftables/nftables.nft (ris. 4.1):
vim (ili nano) /etc/nftables/nftables.nft   – vvod (Enter)
Ris. 4.1
Dalee neobkhodimo dobavit sleduyushchie tablitsy i parametry (ris 4.2), ens19 interfeis smotryashchii vo vneshneyu set:

table inet nat {
	chain postrouting {
		type nat hook postrouting priority srcnat;
		oifname “ens19” masquerade
		}
}

Ris. 4.2

Vklyuchaem i dobavlyaem v avtozagruzku sluzhbu nftables (ris. 4.3):
systemctl enable --now nftables  – vvod (Enter)
Ris. 4.3
Nastraivaem po analogii na HQ-R i BR-R!

5. Nastroika VLAN (TOLKO NA HQ-RTR)!!!
Dobavlyaem v avtozagruzku i zapuskaem (ris. 5.2)
systemctl enable --now openvswitch
systemctl enable --now NetworkManager

Ris.5.2
Sozdaem most (virtualnyi kommutator) hq-sw, Dobavlyaem port ens20 k hq-sw i naznachaem emu vlan100, Dobavlyaem port ens21 k hq-sw i naznachaem emu vlan200, Dobavlyaem port ens22 k hq-sw i naznachaem emu vlan999, Dobavlyaem vnutrennii port vlan100,  vlan200, vlan999 k mostu hq-sw (ris. 5.3).

ovs-vsctl add-br hq-sw
ovs-vsctl add-port hq-sw ens20  tag=100
ovs-vsctl add-port hq-sw ens21 tag=200
ovs-vsctl add-port hq-sw ens22 tag=999
ovs-vsctl add-port hq-sw vlan100 tag=100 -- set interface vlan100 type=internal
ovs-vsctl add-port hq-sw vlan200 tag=200 -- set interface vlan200 type=internal
ovs-vsctl add-port hq-sw vlan999 tag=999 -- set interface vlan999 type=internal

Ris.5.3

Perezagruzhaem openvswitch i NetworkManager (ris.5.4)
systemctl restart openvswitch
systemctl restart NetworkManager
Ris.5.4
Vklyuchaem most (ris. 5.6)
 ip link set hq-sw up
Ris.5.6
Sozdaem skript dlya nastroiki i vosstanovleniya nastroiki ip-adresov VLAN posle perezagruzki!!!
sozdaem skript
nano ip.sh  

pishem tekst skripta:
#!/bin/bash/
ip a add 192.168.0.62/26 dev vlan100
ip a add 192.168.0.78/28 dev vlan200
ip a add 192.168.0.86/29 dev vlan999
zakhodim dobavlyaem zapusk pri zagruzke
nano `/.bashrc
dobavlyaem strochku, i sokhranyaem.
bash ip.sh

Zapuskaem skript
bash ip.sh

Vnimanie!!!! pri perezagruzki sluzhby NM nastroika IP sletayut neobkhodimo neobkhodimo v ruchnuyu zapustit skript ip.sh ili peregruzit PK.

6.  Nastroite lokalnye uchetnye zapisi na ustroistvakh v sootvetstvii s zadaniem (na serverakh polzovatel sshuser c id 1010, na marshrutizatorakh net_admin)
Cervera (ris.6.1)
adduser sshuser -u 2026
passwd sshuser
P@ssw0rd
P@ssw0rd
usermod -aG wheel sshuser
echo "sshuser ALL=(ALL) NOPASSWD: ALL" >> /etc/sudoers

ris.6.1
Marshrutizator (ris.6.2)
adduser net_admin
passwd net_admin 
P@$$word
P@$$word
usermod -aG wheel net_admin
echo "net_admin ALL=(ALL:ALL) NOPASSWD: ALL" >> /etc/sudoers
Ris. 6.2

6. Nastraivaem GRE-tunnel mezhdu HQ-R i BR-R

zapuskaem nastroiku interfeisov komandoi nmtui (ris. 6.1):
nmtui – vvod (Enter)
Ris. 6.1

Vybiraem "Edit a connection" (ris. 6.2):
Ris. 6.2

Vybiraem "Add" (ris.6.3):
Ris. 6.3

Vybiraem "IP tunnel" (ris. 6.4):
Ris. 6.4
Zadaem imya tunelya tun1 -> v "Rezhim raboty" vybiraem "GRE" -> v "Roditelskii" ukazyvaem interfeis ens19 (v storonu ISP) -> zadaem "Lokalnyi IP" -> zadaem "Udalennyi IP" , Perekhodim k  konfiguratsii IPv4 , zadaem parametr “Manual” propisyvaem adresa IPv4 dlya tunnelya -> nazhimaem "OK"  (ris. 6.5):

Ris. 6.5



Vykhodim iz redaktirovaniya tunnelya «<Back>» (ris. 5.7)
Ris. 5.7

zakhodim v razdel «Activete a connection» (ris. 5.8)
Ris. 5.8

Vybiraem tunnel tun1 (parametr stoit «Deactivate») i nazhimaem enter, vyberem snova tun1  (*parametr stoit «Activate») i nazhimaem enter (ris. 5.9)
Ris. 5.9
Vykhodim iz razdela «<Back>”.
Dlya korrektnoi raboty protokola dinamicheskoi marshrutizatsii trebuetsya uvelichit parametr TTL na interfeise tunnelya ispolzuetsya komanda (ris. 6.10):
nmcli connection modify tun1 ip-tunnel.ttl 64  – vvod (Enter)

Ris.6.10
	Nastroika dinamicheskoi (vnutrennei) marshrutizatsii sredstvami frr.

V konfiguratsionnom faile "/etc/frr/daemons" (ris.6.11) neobkhodimo aktivirovat vybrannyi protokol OSPFv2. Perevodim ospfd=no v ospfd=yes - dlya OSPFv2 (IPv4).

nano /etc/frr/daemons   – vvod (Enter)

Ris. 6.11
Sokhranyaem konfiguratsiyu.

Vklyuchaem i dobavlyaem v avtozagruzku sluzhbu frr (ris. 5.12)
systemctl enable --now frr  – vvod (Enter)

Ris.5.12

Nastraivaem OSPFv2 - perekhodim v interfeis frr pri pomoshchi "vtysh" (ris. 5.13):

vtysh – vvod (Enter)
Ris. 5.13

perekhodim v rezhim konfigurirovaniya (ris. 6.14) conf t – vvod (Enter). Komandoi router ospf perekhodim v konfigurirovaniya protakola OSPFv2, perevodim vse interfeisy v passivnyi rezhim komandoi passive-interface default 
conf t – vvod (Enter)
route ospf – vvod (Enter)
passive-interface default – vvod (Enter)
network 10.5.5.0/30 area 0 – vvod (Enter), adres seti tunelya
network 192.168.0.0/26 area 0 – vvod (Enter), adres seti (vnutrennei seti v storanu HQ-SRV)
network 192.168.0.64/28 area 0 – vvod (Enter), adres seti (vnutrennei seti v storanu HQ-CLI)
network 192.168.0.80/29area 0 – vvod (Enter), adres seti (vnutrennei seti v storanu SW)
area 0 authentication – vvod (Enter) Nastroika autentifikatsii dlya oblasti
ex – vvod (Enter)
Perekhodim v konfiguratsiyu tunelya (ris. 5.14), sokhranyaem nastroiku  komandoi wr.
interface tun1 – vvod (Enter)
no ospf network broadcast – vvod (Enter)
no ip ospf passive – vvod (Enter)
ip ospf authentication – vvod (Enter) Nastroika autentifikatsii 
ip ospf authentication-key P@ssw0rd  – vvod (Enter) zadaem parol P@ssw0rd
ex – vvod (Enter)
ex – vvod (Enter)
wr – vvod (Enter)
Ris. 5.14
Vykhodim iz vtysh 
ex – vvod (Enter)
Perezapuskaem FRR
systemctl restart frr
PRIMEChANIE!!! mozhet potrebovatsya perezagruzka BR-RTR i HQ-RTR, posle nee kanal podnimitsya.
Proveryaem konfiguratsiyu zakhodim vo vtysh, esli est ip-adresa vsekh setei so zvezdochkoi  adresa udalennykh podsetei (ris. 5.16):
show ip route ospf – vvod (Enter)
Ris. 5.17 a (br-rtr)
Ris.5.17 b (hq-rtr)
vykhodim iz VTYSH komandoi ex.
Proveryaem marshrut s BR-SRV do HQ-SRV (ris. 5.19) cherez terminal :
traceroute 192.168.0.1  – vvod (Enter)
Ris. 5.19
Nastroika zavershena.
6 . Nastroika DHCP-servera dlya IPv4
Ukazhim setevoi interefeis dlya IPv4, cherez kotoryi budet rabotat DHCP-server
nano /etc/sysconfig/dhcpd – vvod (Enter)
V punkt DHCPDARGS= neobkhodimo dobavit imya setevogo interfeisa vlan200  smotryashchii v lokalnuyu set ofisa HQ (ris. 6.1):
Ris. 6.1
Sokhranyaem parametr i vykhodim.
Sleduyushchim shagom nastraivaem server:
kopiruem nastroiki po umolchaniyu (ris.6.2)

cp /etc/dhcp/dhcpd.conf.example /etc/dhcp/dhcpd.conf   – vvod (Enter)
podtverzhdaem
y – vvod (Enter)

Ris. 6.2

Zakhodim v fail nastroiki
nano /etc/dhcp/dhcpd.conf– vvod (Enter)

Vnosim parametry (ris. 6.3), ostalnye zakomenchivaem:

subnet 192.168.0.64 netmask 255.255.255.240 {
  range 192.168.0.65 192.168.0.75;
  option domain-name-servers 192.168.0.1;
  option domain-name "au-team.irpo";
  option routers 192.168.0.78;
  default-lease-time 6000;
  max-lease-time 7200
}
ris. 6.3

systemctl enable --now dhcpd – vvod (Enter)

 Ris. 6.4

Nastraivaem dinamicheskoe polucheniya ip-adresa na HQ-SRV (ris).
Zakhodim na server i proveryaem poluchenyi ip-adres (ris. 6.5)
 ip a – vvod (Entersystemctl enable --now dhcpd – ввод (Enter)

 Рис. 6.4

Настраиваем динамическое получения ip-адреса на HQ-SRV (рис).
Заходим на сервер и проверяем полученый ip-адрес (рис. 6.5)
 ip a – ввод (Enter)

Рис. 6.5

7. Настройте подключение по SSH для удалённого конфигурирования устройства HQ-SRV и BR-SRV . (рис. 7.1):
nano /etc/openssh/sshd_config  – ввод (Enter)
Рис. 7.1
Port изменим 22 на  2024 и раскоментируем, 
Добавляем следующую строку: AllowUsers sshuser
Находим директиву MaxAuthTries - количество попыток ввода паролю, снимаем комент и ставим значение 2
Находим директиву # Banner none. Снимаем комментарий и указываем путь к файлу /var/banner, который будет содержать текст баннера (рис.7.2).
Рис. 7.2
сохраняем файл.
Заходим в banner и редактируем его (Рис.7.3)
nano /var/banner
Рис.7.3
Сохраняем.
запустим службу ssh (рис. 7.4): 
systemctl enable --now sshd  – ввод (Enter)
Рис. 7.4
Проверяем настройку с любого устройства, через терминал подключаемся к HQ-SRV (рис.7.5)
Рис 7.5
8. Настройка DNS для офисов HQ и BR.
Основной DNS-сервер реализован на HQ-SRV.
Сервер должен обеспечивать разрешение имён в сетевые адреса устройств и обратно в соответствии с таблицей 2
В качестве DNS сервера пересылки используйте любой общедоступный DNS сервер
Редактируем конфигурационный файл /etc/bind/options.conf 
nano  /etc/bind/options.conf 
В данном файле необходимо изменить следующие строки, содержащие
listen-on port 53 {127.0.0.1; 192.168.0.1;};
listen-on-v6 { none; };
forvarders { 77.88.8.7;}: - снять комментирование и добавить ip
allow-query { any; };
dnssec-validation yes
и привести их к виду

Объявляем файлы зон, дописываем в конец файла /etc/bind/local.conf  следующие строки, комментируем строки как указано на рисунке.
где:
Прямая зона
zone "au-team.irpo"{ ... }; определения зоны au-team.irpo. В кавычках указывается имя зоны, которое следует разрешать на этом сервере.
type master ; Указывает тип зоны. type master означает, что эта зона является мастер-зоной, то есть она содержит авторитетные записи, которые могут быть изменены и обновлены на этом сервере.
file "au-team.db"; Указывает путь к файлу, который содержит данные зоны au-team.irpo. Файлы зоны используются для хранения записей DNS, таких как A-записи, CNAME-записи, MX-записи и т. д.
Обратная зона
zone "0.168.192.in-addr.arpa"{ ... }; определения обратной зоны au-team.irpo.
type master; Указывает тип зоны. type master означает, что эта зона является мастер-зоной, то есть она содержит авторитетные записи, которые могут быть изменены и обновлены на этом сервере.

file "au-team_rev.db"; Указывает путь к файлу обратной зоны, который содержит данные обратной зоны au-team.irpo.

Создание локальных зон DNS
Зона прямого просмотра
Для сокращения времени написания файла прямой зоны (au-team.irpo) скопируем шаблон и отредактируем его
# cp /etc/bind/zone/localdomen  /etc/bind/zone/au-team.irpo 

Открываем на редактирование файл зоны au-team.irpo
nano /etc/bind/zone/au-team.irpo 
И приводим его к следующему виду


Зона обратного просмотра
Для сокращения времени написания файла обратной зоны (0.168.192.in-addr.arpa) скопируем шаблон и отредактируем его
# cp /etc/bind/zone/127.in-addr.arpa /etc/bind/zone/168.192.in-addr.arpa
Открываем на редактирование файл зоны 168.192.in-addr.arpa и  3.168.192.in-addr.arpa
nano /etc/bind/zone/168.192.in-addr.arpa
И приводим его к следующему виду
Генерируем ключи
rndc-confgen > /etc/bind/rndc.key
sed -i '6,$d'  /etc/bind/rndc.key

С помощью утилиты named-checkconf проверяется наличие ошибок в конфигурационном файле, если результат выполнения команды пуст - ошибок нет.
Named-checkconf

Назначаем владельца и права.
chown named /etc/bind/zone/au-team.irpo.db
chown named /etc/bind/zone/0168.192.in-addr.arpa
chmod 600 /etc/bind/zone/au-team.irpo.db
chmod 600 /etc/bind/zone/0.168.192.in-addr.arpa

С помощью утилиты named-checkconf -z проверяется наличие ошибок в конфигурационном файле и файлах зон.
named-checkconf  -z

Запускаем службу DNS
systemctl enable --now bind


На HQ-SRV в настройках сетевого интерфейса убедиться, что в качестве первичного DNS сервера указан его собственный IP – адрес

Также необходимо проверить
на BR-SRV, что в качестве первичного DNS сервера указан IP – адрес HQ-SRV 
перезапускаем службу NetworkManager

HQ-CLI - должен получать автоматически по DHC
Запуск и добавление в автозагрузку DNS — сервера:
systemctl enable --now bind 

Тестирование

Обратная зона
Проверка работоспособности DNS с помощью nslookup
Для определения IP-адреса сервера по его доменному:
# nslookup <доменное_имя>
9. Настроим Московский часовой пояс (UTC +3):
timedatectl set-timezone Europe/Moscow
Проверка:
timedatectl
